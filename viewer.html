<!DOCTYPE html>
<html>
<head>
  <title>QTrail Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { padding: 10px 15px; margin: 10px 5px; }
    #summary { display: none; }
    #startBtn { padding: 12px 20px; font-size: 16px; }
    textarea { width: 100%; height: 200px; font-family: monospace; }
  </style>
</head>
<body>
  <h2>Launching your Q&A session...</h2>
  <p id="status">Click below to begin.</p>
  <button id="startBtn" onclick="startSession()">Start Session</button>

  <div id="summary">
    <h3>Session Summary</h3>
    <p>Copy and paste the answers below:</p>
    <textarea id="outputBox" readonly></textarea>
    <h4>JSON (for storage or review):</h4>
    <textarea id="jsonExportBox" readonly style="width:100%; height:150px;"></textarea>
    <p><strong>Review Link:</strong> <a id="reviewLink" href="#" target="_blank"></a></p>
  </div>

  <script>
    const query = new URLSearchParams(window.location.search);
    const data = JSON.parse(decodeURIComponent(query.get("data")));
    const urls = data.urls;
    const questions = data.questions;

    let index = 0;
    let answers = [];

    function openPopup(question, currentIndex) {
      const popupHtml = `
        <html>
        <head><title>QTrail Question</title></head>
        <body style="font-family: sans-serif; padding: 20px;">
          <h3>Question</h3>
          <p>${question}</p>
          <textarea id="answerBox" style="width:100%; height:100px;"></textarea>
          <br/>
          <button onclick="submitAnswer()">Next</button>
          <script>
            function submitAnswer() {
              const answer = document.getElementById('answerBox').value;
              window.opener.postMessage({ type: 'next', answer: answer, index: ${currentIndex} }, '*');
              window.close();
            }
          <\/script>
        </body>
        </html>
      `;
      const blob = new Blob([popupHtml], { type: 'text/html' });
      const popupUrl = URL.createObjectURL(blob);
      window.open(popupUrl, 'QTrailPopup', 'width=400,height=300');
    }

    function nextStep() {
      if (index >= urls.length) {
        document.getElementById("status").innerText = "All done!";
        showSummary();
        return;
      }
      const url = urls[index];
      const question = questions[index];
      openPopup(question, index);
      window.open(url, '_blank');
      index++;
    }

    window.addEventListener("message", (event) => {
      if (event.data.type === "next") {
        answers[event.data.index] = event.data.answer;
        nextStep();
      }
    });

    function showSummary() {
      const summaryText = questions.map((q, i) =>
        `Q${i + 1}: ${q}\nA${i + 1}: ${answers[i] || ''}`
      ).join('\n\n');

      const sessionResult = {
        urls,
        questions,
        answers
      };

      const encodedData = encodeURIComponent(JSON.stringify(sessionResult));
      const reviewLinkUrl = `review.html?data=${encodedData}`;
      const jsonExport = JSON.stringify(sessionResult, null, 2);

      document.getElementById("outputBox").value = summaryText;
      document.getElementById("jsonExportBox").value = jsonExport;
      document.getElementById("reviewLink").href = reviewLinkUrl;
      document.getElementById("reviewLink").textContent = reviewLinkUrl;
      document.getElementById("summary").style.display = 'block';
    }

    function startSession() {
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("status").innerText = "Session started...";
      nextStep();
    }
  </script>
</body>
</html>
