<!DOCTYPE html>
<html>
<head>
  <title>QTrail Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { padding: 10px 15px; margin: 10px 5px; font-size: 16px; }
    #summary { display: none; margin-top: 40px; }
    textarea { width: 100%; height: 200px; font-family: monospace; }
  </style>
</head>
<body>
  <h2>Launching your Q&A session...</h2>

  <p id="status">
    Please click the button below to begin.<br>
    <strong>Important:</strong> This tool opens a tab and a popup.<br>
    Make sure your browser allows popups for this site.
  </p>

  <h5>Need help enabling popups?</h5>
  <ul>
    <li><a href="https://support.google.com/chrome/answer/95472" target="_blank">Enable popups in Chrome</a></li>
    <li><a href="https://support.apple.com/guide/safari/block-pop-ups-sfri40696/mac" target="_blank">Enable popups in Safari</a></li>
    <li><a href="https://support.microsoft.com/en-us/microsoft-edge/block-pop-ups-in-microsoft-edge-4cad471d-2306-3d62-0d09-0503b69de831" target="_blank">Enable popups in Edge</a></li>
  </ul>

  <h4>How it works:</h4>
  <ol>
    <li>A single browser tab will show the pages to review</li>
    <li>A popup will show questions (with back/next/reload)</li>
    <li>Your answers will be saved as you go</li>
  </ol>

  <button id="startBtn" onclick="startSession()">Start Session</button>

  <div id="summary">
    <h3>Session Summary</h3>
    <p id="sessionTitle"></p>
    <textarea id="outputBox" readonly></textarea>
    <p><a id="emailLink" href="#" target="_blank"><button>Send Answers by Email</button></a></p>
  </div>

  <script>
    const query = new URLSearchParams(window.location.search);
    const data = JSON.parse(decodeURIComponent(query.get("data")));
    const { name, urls, questions, senderEmail } = data;
    let answers = data.answers || new Array(questions.length).fill('');

    let index = 0;
    let tabRef = null;
    let popupRef = null;
    let emailHref = '';

    function renderPopup(htmlContent) {
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const popupUrl = URL.createObjectURL(blob);
      if (!popupRef || popupRef.closed) {
        popupRef = window.open(popupUrl, 'QTrailPopup', 'width=450,height=350');
      } else {
        popupRef.location.href = popupUrl;
      }
    }

    function showQuestion(indexToShow) {
      const question = questions[indexToShow];
      const answer = answers[indexToShow] || '';

      const popupHtml = `
        <html>
        <head>
          <meta charset="UTF-8">
          <title>QTrail Question</title>
        </head>
        <body style="font-family: sans-serif; padding: 20px;">
          <h3>Question ${indexToShow + 1} of ${questions.length}</h3>
          <p>${question}</p>
          <textarea id="answerBox" style="width:100%; height:100px;">${answer}</textarea><br/>
          <button onclick="goBack()">Back</button>
          <button onclick="reloadPage()">Reload Page</button>
          <button onclick="goNext()">Next</button>
          <script>
            function goBack() {
              const answer = document.getElementById('answerBox').value;
              window.opener.postMessage({ type: 'nav', direction: 'back', answer: answer }, '*');
            }
            function goNext() {
              const answer = document.getElementById('answerBox').value;
              window.opener.postMessage({ type: 'nav', direction: 'next', answer: answer }, '*');
            }
            function reloadPage() {
              if (window.opener && window.opener.tabRef && !window.opener.tabRef.closed) {
                window.opener.tabRef.location.reload();
              } else if (window.opener) {
                window.opener.location.reload();
              }
            }
          <\/script>
        </body>
        </html>
      `;

      renderPopup(popupHtml);

      if (!tabRef || tabRef.closed) {
        tabRef = window.open(urls[indexToShow], '_blank');
      } else {
        tabRef.location.href = urls[indexToShow];
      }
    }

    window.addEventListener("message", (event) => {
      if (event.data.type === "nav") {
        answers[index] = event.data.answer;

        if (event.data.direction === "next") {
          if (index < questions.length - 1) {
            index++;
            showQuestion(index);
          } else {
            document.getElementById("status").innerText = "All done!";
            showSummary();
            showDonePopup();
          }
        } else if (event.data.direction === "back") {
          if (index > 0) {
            index--;
            showQuestion(index);
          }
        }
      }
    });

    function showSummary() {
      document.getElementById("sessionTitle").innerText = name ? `Session: ${name}` : '';

      const summaryText = questions.map((q, i) =>
        `Q${i + 1}: ${q}\nA${i + 1}: ${answers[i] || '(No answer provided)'}`
      ).join('\n\n');

      const sessionResult = { name, urls, questions, answers, senderEmail };
      const encodedData = encodeURIComponent(JSON.stringify(sessionResult));
      const sessionLink = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;

      const bodyText = `Hi,

I've completed the review session you shared. Here's a summary of my responses:\n\n${summaryText}\n\nYou can also view the full session here:\n${sessionLink}\n\nBest,`;

      const mailtoBody = encodeURIComponent(bodyText);

      emailHref = senderEmail
        ? `mailto:${senderEmail}?subject=${encodeURIComponent("Review session completed" + (name ? `: ${name}` : ''))}&body=${mailtoBody}`
        : '#';

      document.getElementById("outputBox").value = summaryText;

      if (senderEmail) {
        document.getElementById("emailLink").href = emailHref;
        document.getElementById("emailLink").style.display = 'inline';
      } else {
        document.getElementById("emailLink").style.display = 'none';
      }

      document.getElementById("summary").style.display = 'block';
    }

    function showDonePopup() {
      const html = `
        <html>
        <head><meta charset="UTF-8"><title>Done</title></head>
        <body style="font-family: sans-serif; padding: 20px;">
          <h3>All done!</h3>
          <p>Thanks for answering.</p>
          <p><strong>Next step:</strong></p>
          <ul>
            <li><a href="${emailHref}" target="_blank">ðŸ“§ Send answers via email</a></li>
          </ul>
        </body>
        </html>
      `;
      renderPopup(html);
    }

    function startSession() {
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("status").innerText = "Session started...";
      showQuestion(index);
    }

    if (answers.some(a => a)) {
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("status").innerText = "All done!";
      showSummary();
    }
  </script>
</body>
</html>
